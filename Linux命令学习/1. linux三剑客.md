## Linux三剑客
最近在学习Linux中关于shell编程的知识。`grep`、`sed`和`awk`是Linux中处理文件和字符串很重要的命令，有必要学习一下。
- `grep` 文本过滤工具
- `sed` stream editor，流编辑器，文本编辑工具
- `awk` Linux的文本报告生成器（格式化文本）。Linux上是gawk。

### 正则表达式
在学习Linux三剑客之前，先来了解正则表达式。因为Linux三剑客是依靠正则表达式工作的。正则表示式主要分为：
- 基本正则表达式（BRE）
```
BRE对应的元字符有 ^$.[]*
```
- 扩展正则表达式 (ERE)
```
ERE在BRE的基础上，增加上 (){}?+| 等字符
```
正则表达式是按行处理的。

#### 基本正则表达式BRE集合
- 匹配字符
- 匹配次数
- 位置锚定

|符号|作用|
|---|---|
|^|尖角号，用于模式的最左侧，如`^sitama`，匹配以`sitama`单词开头的行|
|$|美元符，用于模式的最右侧，如`*oldboy$`，匹配以`oldboy`单词结尾的行|
|^$|组合符，表示空行|
|.|匹配任意一个且只有一个字符，不能匹配空行|
|\|转义字符，让特殊含义的字符现出原形。例如`\.`代表小数点|
|*|匹配前一个字符(连续出现)0次或一次以上。重复0次代表空，即匹配所有内容|
|.*|组合符，匹配所有字符|
|^.*|组合符，匹配任意多个字符开头的内容|
|.*$|组合符，匹配任意多个字符结尾的内容|
|[abc]|匹配[]集合内任意一个字符，a或b或c，也可以写成[a-c]|
|[^abc]|匹配除了^后面的任意字符，a或b或c，^表示对[abc]的取反。|

#### 扩展正则表达式ERE集合
扩展正则必须用 `grep -E` 才能生效。
|符号|作用|
|---|---|
|+|匹配前一个字符1次或多次|
|[ab]+|匹配括号[]内的`a`或者`b`一次或多次|
|?|匹配前一个字符`0`次或`1`次|
|\||或的含义，表示同时过滤多个字符串|
|()|分组过滤，被括起来的内容表示一个整体|
|a{n,m}|匹配前一个字符最少`n`次，最多`m`次|
|a{n,}|匹配前一个字符最少`n`次|
|a{n}|匹配前一个字符正好`n`次|
|a{,m}|匹配前一个字符最多`m`次|

### grep
> 全拼：Global search REgular expression and Print out the line.
> 作用：文本搜索工具，根据用户指定的模式(过滤条件)，对目标文本逐行进行匹配检查，打印匹配到的行
> 模式：由正则表达式的`元字符`及`文本字符`所编写的`过滤条件`

grep的语法为：
```shell
# 命令 参数    匹配模式   文件名
grep [option] [pattern] file
```

#### grep 参数
|参数选项|解释说明|
|---|---|
|-v|配出匹配结果|
|-n|显示匹配行与行号|
|-i|不区分大小写|
|-c|只统计匹配的行数|
|-E|使用ERE|
|--color=auto|为grep过滤结果添加颜色|
|-w|只匹配过滤的单词|
|-o|只输出匹配的内容|


### sed
sed是Stream Editor的缩写，简称流编辑器。对文件进行增删改查。
```shell
sed [option] [sed内置命令字符] [输入文件]
```
|参数选项|解释|
|---|---|
|-n|取消默认sed的输出，常与sed内置命令p一起用|
|-i|直接将修改结果写入文件，不用-i，sed修改的是内存数据|
|-e|多次编辑，不需要管道符|
|-r|支持正则扩展|

sed的`内置命令字符`用于对文件进行不同的操作功能，如对文件的增删改查。
|sed的内置命令字符|解释|
|---|---|
|a|append,对文本追加，在指定行后面添加一行/多行文本|
|d|Delete，删除匹配行|
|i|insert,表示插入文本，在指定行前添加一行/多行文本|
|p|Pring，打印匹配行的内容，通常p与-n一起使用|
|s/正则/替换内容/g|匹配正则内容，然后替换内容，结尾g代表全局匹配|

sed的匹配范围
|范围|解释|
|---|---|
|空地址|全文处理|
|单地址|指定文件某一行|
|/pattern/|被模式匹配到的每一行|
|范围区间|10,20是到而是行。10,+5第10行向下5行，/pattern1/,/pattern2/|
|步长|1~2,表示1、3、5、7、9...|


### 实战(持续更新)

#### 替换图片URL
一般在本地写博客的时候，图片都是存在本地的文件夹，引用的也是本地的路径。但是当把博客上传到网站时，就需要把路径替换成图床的连接。例如，本地的图片链接为:
```markdown
![](pic/demo.png)
```
需要替换成图床的链接：
```markdown
![](https://pic_beds/demo.png)
```
##### 正则式
考虑到图片的引用格式为：
```markdown
![](pic/demo.png)
```
则可以写出匹配正则式为:
```shell
#    ![]         demo.png
    (\!\[\]).*/(.*\.png)\)
```
##### sed 命令
只需要将第一部分和第二部分保留下来，即用\1 \2表示，假设前缀保存在`prefix`中，使用`sed`命令:
```shell
sed -r "s#(\!\[\]).*/(.*\.png)\)#\1\($prefix/\2\)#"
```
##### shell 脚本
```shell
#!/bin/sh

# 说明: 替换markdown中图片的markdown链接为给定的url链接，一般是在图床上的
# 用法sage: <inputfile> <outputfile> <url>

# 旧的链接：![](abc/edf/风景.png)
# 新的链接: ![](url/风景.png)


echo "find all img reference: "
sed "/\!\[\].*/p" "$1" -n

echo "replacing..."
url=$3
sed -r "s#(\!\[\]).*/(.*\.png)\)#\1\($url/\2\)#g" "$1" > "$2"
echo "finish"
echo "replaced"
sed "/\!\[\].*/p" "$2" -n
```
##### 效果
```shell
$ replace_img_url.sh 3.2\ 程序编码.md test.md https://test_pit

# 结果
find all img reference:
![](pic/3.2%20程序编码/mstore.s.png)
![](pic/3.2%20程序编码/mstore.o.png)
![](pic/3.2%20程序编码/main.c.png)
![](pic/3.2%20程序编码/prog.png)
![](pic/3.2%20程序编码/数据类型.png)
replacing...
finish
replaced
![](https://test_pit/mstore.s.png)
![](https://test_pit/mstore.o.png)
![](https://test_pit/main.c.png)
![](https://test_pit/prog.png)
![](https://test_pit/数据类型.png)
```
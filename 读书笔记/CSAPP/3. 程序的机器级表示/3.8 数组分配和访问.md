## 3.8 数组分配和访问
C语言数组是一种将标量数据聚集成更大数据类型的方式。

### 3.8.1 基本原则
对于数据类型$T$和整形常数$N$，声明如下：

$
T A[N]
$
首先，这个声明会在内存中分配一个$L * N$字节的连续区域，这里$L$是数据类型$T$的大小。其次，它引入了标识符$A$，可以用$A$来作为指向数组开头的指针，这个指针的值就是$x_A$。可以用$0 \sim N-1$的整数索引来访问该数组元素。数组元素$i$会被存放在地址$x_A + L * i$的地方。
![](pic/3.8%20数组分配和访问/数组c.png)
这些声明会产生下列数组：
![](pic/3.8%20数组分配和访问/数组表格.png)

x86-64的内存引用指令可以用来简化数组访问，假设E是一个`int`型的数组，E的地址存放在寄存器`%rdx`中，i存放在寄存器`%rcx`中，则`E[i]`的访问指令为：
```S
    movl (%rdx, %rcx, 4), %eax
```
这样就会指向地址计算$x_E + 4i$，读这个内存位置的值，并将结果存放在寄存器`%eax`中。允许的伸缩因子1、2、4和8覆盖了所有基本简单数据类型的大小。

### 3.8.2 指针运算
C语言允许对指针运算，计算的值会根据指针引用的数据类型大小进行伸缩。扩展一下前面的例子：
![](pic/3.8%20数组分配和访问/指针运算.png)

### 3.8.3 嵌套的数组
创建数组的数组时，数组分配和引用的一般原则也是成立的。比如当声明：
```c
    int A[5][3]
```
等价于下面的声明：
```c
    typedef int row3_t[3];
    row3_t A[5]
```
即将里面的数组看成是一个特殊的类型。

### 3.8.4 定长数组
C语言编译器能够优化定长多维数组上的操作代码，例如当定义整形数组：
```c
    #define N 16
    typedef int fix_matrix[N][N]
```
若是原始的C代码为：
![](pic/3.8%20数组分配和访问/原始C代码.png)

则经过编译器的优化后：
![](pic/3.8%20数组分配和访问/优化C代码.png)

### 3.8.5
C语言只支持大小在编译时就能确定的多维数组，程序员需要变长数组时需要用`malloc`或`calloc`这样的函数为这些数组分配存储空间。

### 小结
数组就是在内存空间中连续的一段内存，x86-64为这样的数组访问提供了方便的内存引用指令。对于多重嵌套的数组而言，最里面的数组作为一种特殊的数据类型T，接着外面一层的数组看成是T的数组。
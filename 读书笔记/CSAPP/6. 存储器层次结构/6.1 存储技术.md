## 6.1 存储技术
计算机技术的成功很大程度上源自于存储技术的巨大进步。早期的计算机只有几千字节的随机访问存储器。到2015年，计算机的存储器容量已经十分庞大。

### 6.1.1 随机访问存储器
随机访问存储器(Random-Access Memory, RAM)分为两类：静态和动态的。静态RAM(SRAM)比动态RAM(DRAM)更快，但也贵的多。

**1. 静态RAM**  
SRAM将每个位存储在一个双稳态(bistable)的存储器单元中，每个单元中的六晶体管电路可以无限期地保持在两个不同的电压配置(configuration)或状态(state)之一。其他任何状态都是不稳定的——从不稳定状态开始，电路会迅速地转移到两个稳定状态之一。
![](pic/6.1%20存储技术/静态RAM稳定状态.png)
SRAM存储器单元的双稳态特性，只要有电，就会永远地保持它的值。即使有干扰来扰乱电压，当干扰消除时，电路就会恢复到稳定值。

**2. 动态RAM**
DRAM将每个位存储为对一个电容的充电。电容通常只有大约30号微微法拉——$30 \times 10^{-15}$法拉。DRAM存储器可以制造的非常密集——每个单元由一个电容和一个访问晶体管组成。但是DRAM存储器对于干扰非常敏感。当电容的电压被扰乱之后，它就永远不会恢复了。暴露在光线下会导致电容电压改变。

很多原因会导致漏电，使得DRAM单元在$10 \sim 100$毫秒时间内失去电荷。幸运的时，计算机运行的始终周期是以纳秒来衡量的，所以相对而言这个保持时间是比较长的。内存系统必须周期性地通过读出，然后重写来刷新内存的每一位。

只要有供电，SRAM就会保持不变，不需要刷新，存储比DRAM快，对诸如光和电噪声的干扰不敏感。代价是SRAM单元比DRAM单元使用更多的晶体管，密集度低，价格更贵，功耗更大。
![](pic/6.1%20存储技术/SRAM和DRAM特性对比.png)

**3. 传统的DRAM**
DRAM芯片中的单元(位)被分成$d$个`超单元(supercell)`，每个超单元都由$w$个DRAM单元组成。一个$d \times w$的DRAM总共存储了$dw$位信息。超单元被组织成一个$r$行$c$列的长方形阵列，这里$rc=d$。每个超单元有形如$(i, j)$的地址。
![](pic/6.1%20存储技术/DRAM超单元视图.png)

每个DRAM芯片被连接到某个称为`内存控制器(memory controller)`的电路，这个电路可以一次传送$w$为到每个DRAM芯片或一次从每个DRAM芯片中传出$w$位。为了读出超单元$(i, j)$的内容，内存控制器将行地址$i$发送到DRAM，然后是列地址$j$。DRAM把超单元$(i, j)$的内容发回控制器作为响应。
![](pic/6.1%20存储技术/读取DRAM超单元.png)
电路设计者将DRAM组织成二维阵列而不是线性数值的一个原因是降低芯片上的地址引脚的数量，缺点就是必须分两步发送地址，增加了访问时间。

**4. 内存模块**
DRAM芯片封装在`内存模块(memory module)`中，它查到主板的扩展槽上。Core i7系统使用的240个引脚的`双列直插内存模块(Dual Inline Memory Module, DIMM)`，以64位为块传送数据到内存控制器和从内存控制器传出数据。

下图中的示例模块用8个64Mbit的$8M \times 8$的DRAM芯片，总共64MB，这8个芯片编号为$0\sim 7$。每个超单元存储主存的一个字节，用相应超单元地址$(i, j)$来表示主存中字节地址A处的64位兹。在示例中，DRAM0存储第一个(地位字节)，DRAM1存储下一个字节，以此类推。

要取出内存地址A处的一个字，内存控制器将A转换成要给超单元地址$(i, j)$，并将它发送到内存模块，然后内存模块将$i$和$j$广播到每个DRAM。每个DRAM输出它的$(i, j)$超单元的8位内容。模块中的电路收集这些输出，并把它们合并成一个64位的字，返回给内存控制器。
![](pic/6.1%20存储技术/读内存模块内容.png)

**5. 增强的DRAM**
基于传统的DRAM单元进行一些优化，提高访问基本DRAM单元的速度。
- 快页模式DRAM(Fast Page Mode DRAM, FPM DRAM)。传统的DRAM将超单元DRAM的一整行幅值到内部缓冲区中，使用一个，然后丢弃剩余的。FPM DRAM运行对同一行连续地址访问可以直接从行缓冲区中得到服务。
- 扩展数据输出DRAM(Extended Data Out DRAM, EDO DRAM)。FPM DRAM的一个增强的形式，允许各个CAS信号在时间上靠得更加紧密一点。
- ...

**6. 非易失性存储器**
一旦断电，DRAM和SRAM会丢失它们的信息，从这个意义上说，它们是`易失的(volatile)`。另一方面，`非易失性存储器(nonvolatile memory)`即使是在关电后，仍然保存这它们的信息。由于历史原因，虽然ROM中有的类型既可以读也可以写，但是它们整体上都被称为`只读存储器(Read-Only Memory, ROM)`。

PROM(Programmable ROM)只能被编程一次。PROM的每个存储器单元有一种熔丝，只能用高电路熔断一次。

`可擦写可编程(Erasable Programmable ROM, EPROM)`有一个透明的石英窗口，允许光到达存储单元。紫外线光照通过窗口，EPROM单元就被清除为0。EPROM能够被擦除和重编程的次数的数量级可以达到1000此。`电子可擦除PROM(Electrically Erasable PROM, EEPROM)`类似于EPROM，但是它不需要一个物理上独立的编程设备，可以直接印制在电路卡上编程，次数可到到100000次。

`闪存(flash memory)`是一类基于EEPROM的非易失性存储器，称为一种重要的存储技术。在后面小节中，我们会仔细研究一种新型的基于闪存的磁盘驱动器，称为`固态硬盘(Solid State Disk, SSD)`，它能提供相对于传统旋转磁盘的一种更快捷、更健壮和更低能耗的选择。

**7. 访问主存**
数据流通过称为`总线(bus)`的共享电子电路在处理器和DRAM主存之间来来回回。每次CPU和主存之间的数据传送都是通过一系列步骤来完成的，这些步骤称为`总线事务(bus transation)`。`读事务(read transaction)`从主存传送数据到CPU。`写事务(write transaction)`从CPU传送数据到主存。

总线是一组并行的导向，能够携带地址、数据和控制信号。取决于总线的设计，数据和地址信号可以共享同一组导线，也可以使用不同的。同时，两个以上的设备也能共享同一总线，控制线携带的信号会同步事务，标识出当前正在被执行的事务的类型。
![](pic/6.1%20存储技术/总线.png)

### 6.1.2 磁盘存储
磁盘是广为应用的保存大量数据的存储设备，从磁盘上读信息的时间为毫秒级，比从DRAM读慢了10万倍，比从SRAM读慢了100万被。

**1. 磁盘构造**
磁盘是由`盘片(platter)`构成的。每个盘片有两个`表面(surface)`，表面覆盖这磁性记录材料。盘片中央有一个可以旋转的`主轴(spindle)`，使得盘片以固定的`旋转速率(rotational rate)`旋转，通常是$5400 \sim 15000$转每分钟(Revolution Per Minute, RPM)。磁盘通常包含一个或多个这样的盘片，并封装在要给密封的容器内。
![](pic/6.1%20存储技术/磁盘构造.png)
上图展现了一个典型的磁盘表面结构。每个表面由一组称为`磁道(track)`的同心圆组成。每个刺刀被划分为一组`扇区(sector)`。每个扇区包含相等数量的数据位(通常是512字节)，这些数据编码在扇区上的磁性材料中。扇区之间由一些`间隙(gap)`分隔开，存储用来表示扇区的格式化位。

磁盘制造商通常用术语`柱面(cylinder)`来描述多个盘片驱动器的构造。柱面是所有盘片表面上到主轴中心的距离相等的集合。图中驱动器有三个盘片六个表面，柱面k就是6个磁道k的集合。

**2. 磁盘容量**
一个磁盘上可以记录的最大位数称为它的`最大容量`，或简称位`容量`。由以下因素决定：
- `记录密度(recording density)(位/英寸)`：磁道一英寸的段中可以放入的位数。
- `磁道密度(track density)(道/英寸)`：从盘片中心出发半径上一英寸的段内可以由的磁道数。
- `面密度(areal density)(位/平方英寸)`：记录密度于磁道密度的乘积。

磁盘制造商不懈努力地提高面密度。最初的磁盘是在面目睹很低的时代设计的，将每个磁道分为数码相同的扇区，扇区的数目是由最靠内的磁道能记录的扇区数决定的。为了保持每个磁道固有的扇区数量，越往外的磁道扇区隔得越开，随着面密度的提高，这种间隙的浪费变得不可接受。因此，现代大容量磁盘使用一种称为`多区记录(multiple zone recording)`，柱面的集合被分割成不相交的子集合，称为`记录区(redording zone)`。每个区包含一组连续的柱面。一个曲中的每个柱面中的每条磁道都有相同数量的扇区。

**3. 磁盘操作**
磁盘用`读/写头(read/write head)`读写存储在磁性表面的位，读写头连接到一个`传动臂(actuator arm)`一端，通过沿着半径轴前后移动传动臂，驱动器可以将读写头定位在盘面上的任何磁道上。这样的机械运动称为`寻道(seek)`。寻道完成后，当磁道上的每个位通过读/写头的下面是，它可以感知到这个位的值，也可以修改这个位的值。
![](pic/6.1%20存储技术/磁盘的动态特性.png)

磁盘以扇区大小的块来读写数据。对扇区的`访问时间(access time)`有三个主要的部分：`寻道时间(seek time)`、`旋转时间(rotational latency)`和`传送时间(transfer time)`:
- **寻道时间**：为了读取某个目标扇区的内容，传动臂要将读/写头定位到包含目标扇区的磁道上。寻道时间$T_{seek}$依赖于读/写头以前的位置和传动臂在盘面上移动的速度。通常为$3 \sim 9$ms。一次寻道的最大时间$T_{max seek}$可以高达20ms。
- **旋转时间**：最坏的情况下，读/写头刚刚错过了目标扇区，必须等待磁盘转一整圈。
  $$
    T_{max rotation}=\frac{1}{RPM} \times \frac{60s}{1min}
  $$
- **传送时间**：依赖于旋转速度和每条磁道的扇区数目
  $$
    T_{avg transfer} = \frac{1}{RPM} \times \frac{1}{平均扇区 / 磁道}\times \frac{60s}{1min}
  $$

实际上，访问一个磁盘扇区中512个字节的时间主要是寻道时间和旋转延迟，寻道时间和旋转延迟大致相等。

**4. 逻辑磁盘块**
现代磁盘将磁道、扇区、表面等结构细节对操作系统隐藏，呈现为一个简单的试图，一个B个扇区大小的`逻辑块`的序列，编号为$0, 1, \cdots, B-1$。磁盘封装中有一个小的硬件/固件设备，称为`磁盘控制器`，维护这逻辑块号和实际磁盘扇区之间的映射关系。

**5. 连接IO设备**
例如图形卡、监视器、鼠标、键盘和磁盘这样的输入/输出(I/O)设备，都是通过`I/O总线`，例如Intel的`外围设备互联(Peripheral Component Interconnect, PCI)`总线连接到CPU和主存。诸如PCI这样的I/O总线设计成与底层CPU无关。例如，PC和Mac都可以使用PCI总线。虽然速度比内存总线慢，但可以容纳种类繁多的第三方I/O设备。
- `通用串行总线(Universal Serial Bus, USB)`控制器是一个连接到USB总线的设备的中转机构。USB总线是一个广泛的使用标准，连接各种外围I/O设备，包括键盘、鼠标、调制解调器、数码相机、外部磁盘驱动器和固态硬盘。USB3.0总线最大带宽为625MB/s。USB3.1总线的最大带宽为1250MB/s。
- `图形卡`(或适配器)包含硬件和软件逻辑，负责代表CPU在显示器上画像素。
- `主机总线适配器`将一个或多个磁盘连接到I/O总线。两个最常用的磁盘接口时SCSI和SATA。SCSI磁盘通常比SATA驱动器更快但是也更贵。
![](pic/6.1%20存储技术/总线结构示例.png)

**6. 访问磁盘**
CPU使用一种称为`内存映射I/O(memory-mapped I/O)`的技术来项I/O设备发射命令。在使用内存映射I/O的系统中，地址空间中有一块地址是为与I/O设备通信保留的。这样的地址称为`I/O端口(I/O port)`。
![](pic/6.1%20存储技术/读取一个磁盘扇区.png)

### 6.1.3 固态硬盘
固态硬盘(Solid State Disk, SSD)是一种基于闪存的存储技术，其行为和其他硬盘一样，处理来此CPU的读写逻辑盘块的请求。一个SSD封装有一个或都哦个闪存芯片和`闪存翻译层(flash translation layer)`组成，闪存芯片替代传统旋转磁盘中的机械驱动器，闪存翻译层扮演与磁盘控制器相同的角色，将对逻辑块的请求翻译成对底层物理设备的访问。
![](pic/6.1%20存储技术/固态硬盘.png)
读SSD比写要快，其差别是由底层闪存的基本属性决定的。在上图中，一个闪存由$B$个块的序列组成，每个块由$P$页组成。通常，页的大小是512字节~4KB，块是由32~128页组成，大小为16KB~512KB。数据以页为单位读写，只有在一页所属的整个块`被擦除`之后，才能写这一页(通常是指该块中的所有位都被设置为1)。不过，一旦一个块被擦除了，块中的每个页都可以直接写。大约进行100000次重复写之后，块就会磨损坏，该块就不能再使用了。
![](pic/6.1%20存储技术/固态硬盘性能特性.png)
随机写很慢，有两个原因。首先，擦除块需要相对较长的时间，1ms级的。其次，如果写操作试图修改一个包含已经有数据的页，那么那么这个块中所有有用数据的页必须被复制到一个新(擦删过的)块，然后才能进行对页的写。

相比旋转磁盘，SSD有很多优点。它们有半导体存储器构成，没有移动的部件，因而随机访问时间比旋转磁盘要块，能耗更低，同时也更结实。但是也有一些缺点。首先，因为反复写之后，闪存块会磨损，所以SSD也容易磨损。闪存翻译层中的`评价磨损(wear leveling)`逻辑试图通过擦除评价分布在所有的块上来最大化每个块的寿命。实际上，评价磨损逻辑处理的非常号，要很多年SSD才会磨损坏。其次，SSD价格更贵。
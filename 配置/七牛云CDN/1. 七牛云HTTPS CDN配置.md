## 七牛云HTTPS CDN配置
由于本人的域名备案是在阿里云，服务器主机在百度云，所以不能直接由备案域名绑定服务器主机，只能设置HTTPS的CDN。以后有条件和需要再设置HTTP的CDN。

### 拥有资源
- 阿里云备案的二级域名 mytest.top。
- 阿里云免费SSL证书。
- 百度云服务器。

### CDN配置
1. CDN的加速三级域名为`cdn.mytest.top`。需要在阿里云为该域名申请SSL证书。搜索SSL证书，进入SSL证书管理控制台。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/SSL证书控制台.png)
   点击免费证书，购买后点击创建证书。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/SSL证书申请.png)
   申请成功后会有下载选项。选择Nginx格式下载后有两个文件，`cdn.mytest.top.pem`和`cdn.mytest.top.key`。这样SSL证书就申请好了。
2. 进入七牛云CDN控制台，创建一个新的加速域名。加速域名输入上一步的`cdn.mytest.top`。
![](pic/1.%20七牛云HTTPS%20CDN配置/七牛云域名配置.png)

3. 配置CDN回源时的源站。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/七牛云源站配置.png)
   这里需要注意的是，通过IP地址可以找到百度云服务器，而通过回源HOST则找到运行服务的那个站点。因为一台云服务器可以运行多个网站。而我们没有配置这个站点，所以这里的源站测试是无法通过的，需要对百度云服务器做一些配置。
4. 配置百度云服务器。我这里用的是宝塔面板配置站点，站点域名要和回源HOST一致，否则回源时就找不到对应的站点了。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/百度云服务器源站配置.png) 
   当然这里你也可以开启HTTPS回源，不过这样就得再为这个域名申请一个SSL证书，方法与第一步一样。这里我简单就用HTTP协议回源。注意，回源协议与CDN协议不是同一个，两个可以不同。添加了这个站点后，七牛云CDN的回源测试就能通过了。

5. 缓存配置就使用推荐配置即可。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/七牛云缓存配置.png)
   点击确定就能够创建一个七牛云CDN加速域名。
6. HTTPS配置。之前下载的证书文件就派上用场了。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/七牛云HTTPS配置.png) 
7. CNAME配置。创建完后需要配置CNAME。拷贝七牛云CDN加速域名的CNAME记录值。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/七牛云CNAME.png)
   回到阿里云域名解析控制台，添加一条解析记录。
   ![](pic/1.%20七牛云HTTPS%20CDN配置/阿里云域名解析.png)
   等待几分钟，七牛云的CDN加速域名显示为`已配置`，则完成了。
8. Nginx反向代理。此时我们在浏览器中访问`https://cdn.mytest.top`，应该会返回Niginx的页面。因为我们在第3步配置源站时，回源HOST设置的是Nginx的服务站点。所以要将这个Nginx站点代理到真正的服务(博客服务)。假如博客服务监听的站点时8090。在宝塔站点面板中创建一条反向代理。
![](pic/1.%20七牛云HTTPS%20CDN配置/Nginx代理.png)
之后CDN就能回源到正确的服务上了。

### 源站与CDN的关系图
那浏览器是怎么获取服务的呢？
![](pic/1.%20七牛云HTTPS%20CDN配置/CDN关系.drawio.png)
1. 首先一个备案的二级域名可以有很多个三级域名，浏览器可以访问这个三级域名，比如`cdn.mytest.top`。
2. `cdn.mytest.top`通过域名解析`CNAME`就和一个七牛云CDN实例绑定了。这个CDN实例又通过IP地址找到了百度云服务器主机。
3. 百度云服务器主机上开了很多个站点，怎么知道要找那个站点呢？根据回源HOST中指定的主机就能找到对应的站点。
4. 该站点代理了博客服务，因此将请求转发给了博客服务，就访问到了博客网站。
5. 这个过程中，CDN会缓存静态资源，只有请求未命中缓存的资源时，才会访问源站回源，用户是感知不到百度云服务器的，只会以为是在访问CDN结点。

### 一点题外话
为什么一定要用HTTPS协议的CDN呢？因为在Google浏览器中，很多HTTP请求都被替换成了HTTPS请求了，并且HTTPS协议也更加安全。而七牛云的HTTPS协议的CDN是收费的，0.28米/G，也不算贵。但是那免费的10G的HTTP协议的CDN就浪费了吗？
回忆配置过程中，CDN协议和回源协议是两个独立的协议，那么如果能实现用HTTPS协议访问百度云主机上的某个站点，然后该站点代理了七牛云的HTTP协议的CDN，而该CDN再用HTTPS协议与百度云主机上的博客服务站点回源不就行了吗？
这个操作就是再加了一层代理，让该代理用HTTP协议转发到CDN结点上。要实现这种效果需要一个条件——就是要有一个域名能够访问到百度云主机。很遗憾的是，本人的域名备案是在阿里云，云服务器在百度云，所以在第一步就会被百度云拦截，视为未备案域名。这也是在配置源站时只能用IP地址找到百度云主机的原因。之后有条件和机会再来捣鼓吧。
![](pic/1.%20七牛云HTTPS%20CDN配置/HTTP协议CDN.png)